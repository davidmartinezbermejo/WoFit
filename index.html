<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Analizador FIT - Gráfica y Mapa Sincronizados</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 0; display: grid; grid-template-rows: auto 1fr 1fr; height: 100vh; background: #f4f4f4; }
        .header { padding: 10px 20px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; }
        #map { width: 100%; height: 100%; }
        .chart-container { background: white; padding: 10px; border-top: 2px solid #ddd; position: relative; }
        canvas { width: 100% !important; height: 100% !important; }
        .controls { display: flex; gap: 20px; align-items: center; }
        .file-input { font-size: 12px; }
    </style>
</head>
<body>

<div class="header">
    <div class="controls">
        <div><strong>Archivo 1 (—):</strong> <input type="file" id="file1" class="file-input"></div>
        <div><strong>Archivo 2 (---):</strong> <input type="file" id="file2" class="file-input"></div>
        <div>
            <label>Métrica:</label>
            <select id="metricSelect">
                <option value="heartRate">Frecuencia Cardíaca</option>
                <option value="enhancedSpeed">Velocidad</option>
                <option value="enhancedAltitude">Altitud</option>
                <option value="cadence">Cadencia</option>
            </select>
        </div>
        <div id="similitud">Similitud: --</div>
    </div>
</div>

<div id="map"></div>

<div class="chart-container">
    <canvas id="performanceChart"></canvas>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

<script type="module">
    import { Decoder, Stream } from 'https://cdn.jsdelivr.net/npm/@garmin/fitsdk@21.126.0/+esm';

    // Configuración Inicial
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let chart;
    let dataStore = { file1: [], file2: [] };
    const markers = { file1: L.circleMarker([0,0], {color: 'blue'}).addTo(map), 
                      file2: L.circleMarker([0,0], {color: 'red'}).addTo(map) };

    const colors = { heartRate: '#e74c3c', enhancedSpeed: '#2ecc71', enhancedAltitude: '#f1c40f', cadence: '#9b59b6' };

    // Inicializar Gráfica
    const ctx = document.getElementById('performanceChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'Archivo 1', data: [], borderColor: 'blue', borderWidth: 2, pointRadius: 0, fill: false },
            { label: 'Archivo 2', data: [], borderColor: 'red', borderDash: [5, 5], borderWidth: 2, pointRadius: 0, fill: false }
        ]},
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            onClick: (e, elements) => {
                if (elements.length > 0) syncChartToMap(elements[0].index);
            },
            plugins: {
                zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } }
            }
        }
    });

    async function handleFile(e, key) {
        const file = e.target.files[0];
        const arrayBuffer = await file.arrayBuffer();
        const decoder = new Decoder(Stream.fromByteArray(new Uint8Array(arrayBuffer)));
        const { messages } = decoder.read();
        
        // Guardamos solo registros con GPS
        dataStore[key] = messages.recordMesgs.filter(m => m.positionLat && m.positionLong).map(m => ({
            ...m,
            lat: m.positionLat * (180 / Math.pow(2, 31)),
            lng: m.positionLong * (180 / Math.pow(2, 31))
        }));

        const coords = dataStore[key].map(m => [m.lat, m.lng]);
        const poly = L.polyline(coords, { color: key === 'file1' ? 'blue' : 'red', dashArray: key === 'file1' ? '' : '5, 10' }).addTo(map);
        
        // Evento: Pinchar en el mapa busca el punto en la gráfica
        poly.on('click', (ev) => {
            const index = findNearestIndex(coords, ev.latlng);
            syncMapToChart(index);
        });

        map.fitBounds(poly.getBounds());
        updateChart();
    }

    function updateChart() {
        const metric = document.getElementById('metricSelect').value;
        chart.data.datasets[0].label = `Archivo 1 (${metric})`;
        chart.data.datasets[0].borderColor = colors[metric];
        chart.data.datasets[1].borderColor = colors[metric];
        
        const maxLen = Math.max(dataStore.file1.length, dataStore.file2.length);
        chart.data.labels = Array.from({length: maxLen}, (_, i) => i);
        
        chart.data.datasets[0].data = dataStore.file1.map(m => m[metric] || 0);
        chart.data.datasets[1].data = dataStore.file2.map(m => m[metric] || 0);
        chart.update();
    }

    function syncChartToMap(index) {
        if (dataStore.file1[index]) markers.file1.setLatLng([dataStore.file1[index].lat, dataStore.file1[index].lng]);
        if (dataStore.file2[index]) markers.file2.setLatLng([dataStore.file2[index].lat, dataStore.file2[index].lng]);
    }

    function syncMapToChart(index) {
        chart.setActiveElements([{ datasetIndex: 0, index: index }]);
        chart.tooltip.setActiveElements([{ datasetIndex: 0, index: index }]);
        chart.update();
        syncChartToMap(index);
    }

    function findNearestIndex(coords, latlng) {
        let minDist = Infinity, index = 0;
        coords.forEach((c, i) => {
            const d = map.distance(latlng, c);
            if (d < minDist) { minDist = d; index = i; }
        });
        return index;
    }

    document.getElementById('file1').onchange = (e) => handleFile(e, 'file1');
    document.getElementById('file2').onchange = (e) => handleFile(e, 'file2');
    document.getElementById('metricSelect').onchange = updateChart;
</script>

</body>
</html>