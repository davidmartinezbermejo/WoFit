<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>FIT Sync Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        :root {
            --panel-width: 300px;
        }

        body {
            font-family: sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background: #1a1a1a;
        }

        .toolbar {
            background: #2c3e50;
            color: white;
            padding: 10px;
            display: flex;
            gap: 20px;
            z-index: 2001;
            border-bottom: 1px solid #34495e;
            position: relative;
        }

        .tool-button {
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #main-wrapper {
            display: flex;
            flex: 1;
            width: calc(100% + var(--panel-width));
            transition: transform 0.3s ease;
            transform: translateX(calc(-1 * var(--panel-width)));
        }

        #main-wrapper.shifted {
            transform: translateX(0);
        }

        .side-panel {
            width: var(--panel-width);
            height: 100%;
            background: #2c3e50;
            color: white;
            padding: 20px;
            box-sizing: border-box;
            flex-shrink: 0;
            border-right: 1px solid #444;
            position: relative;
        }

        .panel-content {
            position: relative;
            width: 100%;
        }

        .close-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            cursor: pointer;
            color: #bdc3c7;
            font-size: 1.4rem;
            padding: 5px;
            z-index: 10;
        }

        #content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #fff;
            width: 100vw;
        }

        #map {
            height: 45vh;
            width: 100%;
            flex-shrink: 0;
        }

        .bottom-section {
            flex: 1;
            display: flex;
            overflow: hidden;
            border-top: 2px solid #2c3e50;
        }

        .chart-container {
            width: 80%;
            position: relative;
            padding: 10px;
            box-sizing: border-box;
        }

        .data-info-panel {
            width: 20%;
            background: #f8f9fa;
            border-left: 1px solid #ddd;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .zoom-controls {
            display: flex;
            gap: 5px;
        }

        .zoom-controls button {
            flex: 1;
            padding: 8px;
            cursor: pointer;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
        }

        /* Layout de dos columnas para las tarjetas */
        #tooltip-data {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: space-between;
        }

        .data-card {
            width: 48%;
            display: flex;
            flex-direction: column;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            border-left: 4px solid #ccc;
            box-sizing: border-box;
        }

        .card-title {
            font-size: 10px;
            font-weight: bold;
            color: #555;
            text-transform: uppercase;
            border-bottom: 1px solid #eee;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #333;
        }

        .card-row .file-label {
            font-weight: bold;
            color: #888;
            font-size: 10px;
        }

        .time-display {
            width: 100%;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            color: #2c3e50;
            padding: 8px;
            background: #eef2f7;
            border-radius: 4px;
            border: 1px solid #d1d9e4;
            box-sizing: border-box;
        }

        .metric-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #34495e;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 8px;
            color: white;
        }
    </style>
</head>

<body>

    <div class="toolbar">
        <div class="tool-button" onclick="openPanel('panel-files')"><i class="fas fa-file-import"></i>
            <span>Archivos</span></div>
        <div class="tool-button" onclick="openPanel('panel-metrics')"><i class="fas fa-chart-line"></i>
            <span>Parámetros</span></div>
    </div>

    <div id="main-wrapper">
        <aside class="side-panel">
            <div id="panel-files" class="panel-content" style="display:none">
                <i class="fas fa-times close-btn" onclick="closePanels()"></i>
                <h3>Archivos y Offset</h3>
                <input type="file" id="file1" style="width:100%; margin-bottom:10px;">
                <input type="file" id="file2" style="width:100%; margin-bottom:10px;">
                <label style="font-size:12px">Offset F2 (seg):</label>
                <input type="number" id="offset" value="0" style="width:100%">
            </div>
            <div id="panel-metrics" class="panel-content" style="display:none">
                <i class="fas fa-times close-btn" onclick="closePanels()"></i>
                <h3>Métricas y Colores</h3>
                <div id="metrics"></div>
            </div>
        </aside>

        <main id="content-area">
            <div id="map"></div>
            <div class="bottom-section">
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
                <div class="data-info-panel">
                    <div class="zoom-controls">
                        <button id="zoomIn">+</button>
                        <button id="zoomOut">-</button>
                        <button id="resetZoom">Reset</button>
                    </div>
                    <div id="tooltip-display">
                        <h4
                            style="margin:0 0 10px 0; border-bottom: 1px solid #ccc; padding-bottom: 5px; font-size: 14px;">
                            Comparativa</h4>
                        <div id="tooltip-data">
                            <p style="color:#888; font-size: 12px; text-align: center; width: 100%;">Mueve el ratón
                                sobre la gráfica</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

    <script type="module">
        import { Decoder, Stream } from 'https://cdn.jsdelivr.net/npm/@garmin/fitsdk@21.126.0/+esm';

        let chart;
        let dataStore = { f1: [], f2: [] };
        const paramColors = { heartRate: '#ff0000', speed: '#0000ff', cadence: '#ffff00', power: '#a020f0', altitude: '#00ff00' };

        const formatTime = (s) => {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = Math.floor(s % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        };

        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const layers = { f1: L.featureGroup().addTo(map), f2: L.featureGroup().addTo(map) };
        const cursors = {
            f1: L.circleMarker([0, 0], { color: 'blue', radius: 6, fillOpacity: 1 }).addTo(map),
            f2: L.circleMarker([0, 0], { color: 'red', radius: 6, fillOpacity: 1 }).addTo(map)
        };

        const ctx = document.getElementById('mainChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: { x: { type: 'linear', ticks: { callback: v => formatTime(v) } } },
                plugins: {
                    legend: { display: false },
                    zoom: { zoom: { wheel: { enabled: false }, mode: 'x' }, pan: { enabled: true, mode: 'x' } },
                    tooltip: {
                        enabled: false,
                        external: function (context) {
                            const container = document.getElementById('tooltip-data');
                            if (context.tooltip.opacity === 0) return;

                            const timeSec = parseFloat(context.tooltip.title[0]);
                            let html = `<div class="time-display">${formatTime(timeSec)}</div>`;

                            const groups = {};
                            context.tooltip.body.forEach((body, i) => {
                                const ds = chart.data.datasets[i];
                                const parts = ds.label.split(' ');
                                const fileKey = parts[0];
                                const metricName = parts.slice(1).join(' ');

                                if (!groups[metricName]) groups[metricName] = { color: ds.borderColor, f1: '-', f2: '-' };
                                groups[metricName][fileKey.toLowerCase()] = body.lines[0].split(':')[1];
                            });

                            for (const [name, data] of Object.entries(groups)) {
                                html += `
                                    <div class="data-card" style="border-left-color: ${data.color}">
                                        <div class="card-title">${name}</div>
                                        <div class="card-row"><span class="file-label">F1:</span> <span>${data.f1}</span></div>
                                        <div class="card-row"><span class="file-label">F2:</span> <span>${data.f2}</span></div>
                                    </div>`;
                            }
                            container.innerHTML = html;
                            moveCursors(timeSec);
                        }
                    }
                }
            }
        });

        window.openPanel = (id) => {
            document.querySelectorAll('.panel-content').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            document.getElementById('main-wrapper').classList.add('shifted');
            setTimeout(() => { map.invalidateSize(); chart.resize(); }, 300);
        };

        window.closePanels = () => {
            document.getElementById('main-wrapper').classList.remove('shifted');
            setTimeout(() => { map.invalidateSize(); chart.resize(); }, 300);
        };

        async function processFit(file, key) {
            if (!file) return;
            const buffer = await file.arrayBuffer();
            const decoder = new Decoder(Stream.fromByteArray(new Uint8Array(buffer)));
            const { messages } = decoder.read();
            const records = (messages.recordMesgs || []).filter(m => m.positionLat);
            if (!records.length) return;

            const startT = records[0].timestamp.getTime();
            dataStore[key] = records.map(m => {
                const obj = {
                    t: (m.timestamp.getTime() - startT) / 1000,
                    lat: m.positionLat * (180 / 2147483648),
                    lng: m.positionLong * (180 / 2147483648)
                };

                for (let k in m) {
                    if (typeof m[k] === 'number') {
                        // Conversión de speed: de m/s a km/h
                        if (k === 'speed') {
                            obj[k] = parseFloat((m[k] * 3.6).toFixed(2));
                        } else {
                            obj[k] = m[k];
                        }
                    }
                }
                return obj;
            });

            drawRoute(key);
            buildMetricSelectors();
            window.updateChartGlobal();
        }

        function drawRoute(key) {
            layers[key].clearLayers();
            const color = key === 'f1' ? 'blue' : 'red';
            const pts = dataStore[key].map(d => [d.lat, d.lng]);
            L.polyline(pts, { color: color, weight: 3 }).addTo(layers[key]);
            if (pts.length) map.fitBounds(L.latLngBounds([...dataStore.f1, ...dataStore.f2].map(d => [d.lat, d.lng])));
        }

        function buildMetricSelectors() {
            const div = document.getElementById('metrics');
            const keys = new Set();
            [...dataStore.f1, ...dataStore.f2].forEach(r => Object.keys(r).forEach(k => { if (!['t', 'lat', 'lng'].includes(k)) keys.add(k); }));
            div.innerHTML = Array.from(keys).sort().map(m => {
                if (!paramColors[m]) paramColors[m] = '#999';
                return `<div class="metric-item">
                    <input type="checkbox" value="${m}" ${m === 'heartRate' ? 'checked' : ''} onchange="window.updateChartGlobal()">
                    <input type="color" value="${paramColors[m]}" oninput="window.updateParamColor('${m}', this.value)">
                    <span>${m}</span>
                </div>`;
            }).join('');
        }

        window.updateParamColor = (m, c) => { paramColors[m] = c; window.updateChartGlobal(); };

        window.updateChartGlobal = () => {
            const off = parseFloat(document.getElementById('offset').value) || 0;
            const selected = Array.from(document.querySelectorAll('#metrics input[type="checkbox"]:checked')).map(i => i.value);
            chart.data.datasets = [];
            const newScales = { x: chart.options.scales.x };
            selected.forEach((m, i) => {
                const color = paramColors[m];
                const axisId = `y-${m}`;
                newScales[axisId] = {
                    type: 'linear', display: true, position: 'left',
                    ticks: { color: color }, grid: { drawOnChartArea: i === 0 },
                    afterDataLimits: (axis) => { const range = axis.max - axis.min; const p = range === 0 ? 1 : range * 0.5; axis.min -= p; axis.max += p; }
                };
                ['f1', 'f2'].forEach(key => {
                    if (dataStore[key].length) chart.data.datasets.push({
                        label: `${key.toUpperCase()} ${m}`,
                        data: dataStore[key].map(d => ({ x: d.t + (key === 'f2' ? off : 0), y: d[m] })),
                        borderColor: color, yAxisID: axisId, pointRadius: 0, borderWidth: 2, borderDash: key === 'f2' ? [5, 5] : []
                    });
                });
            });
            chart.options.scales = newScales;
            chart.update();
        };

        function moveCursors(t) {
            const off = parseFloat(document.getElementById('offset').value) || 0;
            ['f1', 'f2'].forEach(key => {
                if (!dataStore[key].length) return;
                const o = key === 'f2' ? off : 0;
                const c = dataStore[key].reduce((a, b) => Math.abs((a.t + o) - t) < Math.abs((b.t + o) - t) ? a : b);
                cursors[key].setLatLng([c.lat, c.lng]);
            });
        }

        document.getElementById('file1').onchange = e => processFit(e.target.files[0], 'f1');
        document.getElementById('file2').onchange = e => processFit(e.target.files[0], 'f2');
        document.getElementById('offset').oninput = window.updateChartGlobal;
        document.getElementById('zoomIn').onclick = () => chart.zoom(1.1);
        document.getElementById('zoomOut').onclick = () => chart.zoom(0.9);
        document.getElementById('resetZoom').onclick = () => chart.resetZoom();

        window.openPanel('panel-files');
    </script>
</body>

</html>