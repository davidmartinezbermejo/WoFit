<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>FIT Sync Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        :root { --panel-width: 300px; }
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: #1a1a1a; }
        
        .toolbar { background: #2c3e50; color: white; padding: 10px; display: flex; gap: 20px; z-index: 2001; border-bottom: 1px solid #34495e; position: relative; }
        .tool-button { cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; transition: color 0.2s; }
        .tool-button:hover { color: #3498db; }

        #main-wrapper { display: flex; flex: 1; width: calc(100% + var(--panel-width)); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(calc(-1 * var(--panel-width))); }
        #main-wrapper.shifted { transform: translateX(0); }

        .side-panel { width: var(--panel-width); height: 100%; background: #2c3e50; color: white; padding: 20px; box-sizing: border-box; flex-shrink: 0; overflow-y: auto; position: relative; z-index: 2100; border-right: 1px solid #444; }
        .panel-content { position: relative; }
        .panel-content h3 { margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 1.1rem; padding-right: 30px; }
        
        /* Botón X de cierre */
        .close-btn { position: absolute; top: 0; right: 0; cursor: pointer; font-size: 1.2rem; color: #bdc3c7; transition: color 0.2s; }
        .close-btn:hover { color: #e74c3c; }

        #content-area { flex: 1; display: flex; flex-direction: column; height: 100%; background: #fff; width: 100vw; position: relative; }
        
        #map { height: 45vh; width: 100%; background: #ddd; flex-shrink: 0; }
        .chart-container { flex: 1; padding: 10px; background: white; min-height: 0; position: relative; }
        
        .config-group { display: flex; flex-direction: column; gap: 15px; margin-top: 15px; }
        .config-group label { font-size: 12px; color: #bdc3c7; display: block; margin-bottom: 4px; }
        #metrics { display: flex; flex-direction: column; gap: 8px; }
        .metric-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: #34495e; border-radius: 4px; font-size: 13px; }
        #resetZoom { position: absolute; top: 15px; right: 25px; z-index: 10; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="tool-button" onclick="openPanel('panel-files')">
            <i class="fas fa-file-import"></i> <span>Archivos</span>
        </div>
        <div class="tool-button" onclick="openPanel('panel-metrics')">
            <i class="fas fa-chart-line"></i> <span>Parámetros</span>
        </div>
    </div>

    <div id="main-wrapper">
        <aside class="side-panel">
            <div id="panel-files" class="panel-content" style="display:none">
                <i class="fas fa-times close-btn" onclick="closePanels()"></i>
                <h3>Archivos y Offset</h3>
                <div class="config-group">
                    <div>
                        <label>Archivo 1 (F1):</label>
                        <input type="file" id="file1" style="width:100%">
                    </div>
                    <div>
                        <label>Archivo 2 (F2):</label>
                        <input type="file" id="file2" style="width:100%">
                    </div>
                    <div>
                        <label>Offset F2 (segundos):</label>
                        <input type="number" id="offset" value="0" style="width:100%; box-sizing: border-box;">
                    </div>
                </div>
            </div>

            <div id="panel-metrics" class="panel-content" style="display:none">
                <i class="fas fa-times close-btn" onclick="closePanels()"></i>
                <h3>Métricas y Colores</h3>
                <div id="metrics"><p style="font-size:12px; color:#bdc3c7;">Carga archivos para ver métricas.</p></div>
            </div>
        </aside>

        <main id="content-area">
            <div id="map"></div>
            <div class="chart-container">
                <button id="resetZoom">Reset Zoom</button>
                <canvas id="mainChart"></canvas>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

    <script type="module">
        import { Decoder, Stream } from 'https://cdn.jsdelivr.net/npm/@garmin/fitsdk@21.126.0/+esm';

        window.openPanel = (contentId) => {
            const wrapper = document.getElementById('main-wrapper');
            document.querySelectorAll('.panel-content').forEach(p => p.style.display = 'none');
            document.getElementById(contentId).style.display = 'block';
            wrapper.classList.add('shifted');
            setTimeout(() => { map.invalidateSize(); if(chart) chart.resize(); }, 300);
        };

        window.closePanels = () => {
            document.getElementById('main-wrapper').classList.remove('shifted');
            setTimeout(() => { map.invalidateSize(); if(chart) chart.resize(); }, 300);
        };

        let chart;
        let dataStore = { f1: [], f2: [] };
        const paramColors = { heartRate: '#ff0000', speed: '#0000ff', cadence: '#ffff00', power: '#a020f0', altitude: '#00ff00' };

        const formatTime = (s) => {
            const abs = Math.abs(s);
            const h = Math.floor(abs / 3600).toString().padStart(2, '0');
            const m = Math.floor((abs % 3600) / 60).toString().padStart(2, '0');
            const sec = Math.floor(abs % 60).toString().padStart(2, '0');
            return `${s < 0 ? '-' : ''}${h}:${m}:${sec}`;
        };

        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const layers = { f1: L.featureGroup().addTo(map), f2: L.featureGroup().addTo(map) };
        const cursors = {
            f1: L.circleMarker([0,0], {color: 'blue', radius: 6, fillOpacity: 1}).addTo(map),
            f2: L.circleMarker([0,0], {color: 'red', radius: 6, fillOpacity: 1}).addTo(map)
        };

        const ctx = document.getElementById('mainChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: { x: { type: 'linear', ticks: { callback: v => formatTime(v) } } },
                plugins: {
                    zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, mode: 'x' } },
                    tooltip: {
                        callbacks: {
                            title: (items) => formatTime(items[0].parsed.x),
                            afterBody: (items) => { moveCursors(items[0].parsed.x); return ""; }
                        }
                    }
                }
            }
        });

        async function processFit(file, key) {
            if (!file) return;
            const buffer = await file.arrayBuffer();
            const decoder = new Decoder(Stream.fromByteArray(new Uint8Array(buffer)));
            const { messages } = decoder.read();
            const records = (messages.recordMesgs || []).filter(m => m.positionLat);
            if (!records.length) return;
            const startT = records[0].timestamp.getTime();
            dataStore[key] = records.map(m => {
                const obj = { t: (m.timestamp.getTime() - startT) / 1000, lat: m.positionLat * (180/2147483648), lng: m.positionLong * (180/2147483648) };
                for (let k in m) if (typeof m[k] === 'number') obj[k] = m[k];
                return obj;
            });
            drawRoute(key); buildMetricSelectors(); updateChart();
        }

        function buildMetricSelectors() {
            const div = document.getElementById('metrics');
            div.innerHTML = '';
            const keys = new Set();
            [...dataStore.f1, ...dataStore.f2].forEach(r => Object.keys(r).forEach(k => { if(!['t','lat','lng'].includes(k)) keys.add(k); }));
            
            Array.from(keys).sort().forEach(m => {
                if (!paramColors[m]) paramColors[m] = '#999999';
                const item = document.createElement('div');
                item.className = 'metric-item';
                item.innerHTML = `
                    <input type="checkbox" value="${m}" ${m === 'heartRate' ? 'checked' : ''}>
                    <input type="color" value="${paramColors[m]}" style="width:25px;height:25px;border:none;background:none;cursor:pointer">
                    <span style="flex:1">${m}</span>
                `;
                item.querySelector('input[type="checkbox"]').onchange = updateChart;
                item.querySelector('input[type="color"]').oninput = (e) => { paramColors[m] = e.target.value; updateChart(); };
                div.appendChild(item);
            });
        }

        function updateChart() {
            const off = parseFloat(document.getElementById('offset').value) || 0;
            const selected = Array.from(document.querySelectorAll('#metrics input[type="checkbox"]:checked')).map(i => i.value);
            chart.data.datasets = [];
            selected.forEach((m, i) => {
                const color = paramColors[m];
                ['f1', 'f2'].forEach(key => {
                    if (dataStore[key].length) {
                        chart.data.datasets.push({
                            label: `${key.toUpperCase()}: ${m}`,
                            data: dataStore[key].map(d => ({ x: d.t + (key==='f2'?off:0), y: d[m] })),
                            borderColor: color, yAxisID: 'y', pointRadius: 0, borderWidth: 2,
                            borderDash: key==='f2'?[5,5]:[]
                        });
                    }
                });
            });
            chart.update();
        }

        function drawRoute(key) {
            layers[key].clearLayers();
            const color = key === 'f1' ? 'blue' : 'red';
            const pts = dataStore[key].map(d => [d.lat, d.lng]);
            L.polyline(pts, { color: color, weight: 3 }).addTo(layers[key]);
            const allPts = [...dataStore.f1, ...dataStore.f2].map(d => [d.lat, d.lng]);
            if (allPts.length) map.fitBounds(L.latLngBounds(allPts));
        }

        function moveCursors(t) {
            const off = parseFloat(document.getElementById('offset').value) || 0;
            ['f1', 'f2'].forEach(key => {
                if (!dataStore[key].length) return;
                const o = key === 'f2' ? off : 0;
                const c = dataStore[key].reduce((a, b) => Math.abs((a.t + o) - t) < Math.abs((b.t + o) - t) ? a : b);
                cursors[key].setLatLng([c.lat, c.lng]);
            });
        }

        document.getElementById('file1').onchange = e => processFit(e.target.files[0], 'f1');
        document.getElementById('file2').onchange = e => processFit(e.target.files[0], 'f2');
        document.getElementById('offset').oninput = updateChart;
        document.getElementById('resetZoom').onclick = () => chart.resetZoom();
    </script>
</body>
</html>